pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
--ghost game

function _init()
	init_title()
	init_player()
	init_lights()
	init_end()
end

function _update()
	if title then
		update_title()
	elseif gameover then
		update_end()
	else
		update_player()
		update_lights()
	end
end

function _draw()
	cls()
	if title then
		draw_title()
	elseif gameover then
		draw_end()
	else
		draw_lights()
		draw_player()
	end
end

-->8
--title

function init_title()
	title = true
	logo = {
		sprite = 72,
		x = 32,
		y = 32,
		w = 8,
		h = 4
	}
end

function update_title()
	if btnp(❎) then
		title = false
	end
end

function draw_title()
	spr(
		logo.sprite,
		logo.x,
		logo.y,
		logo.w,
		logo.h
	)
	print(
		"- press ❎ to start -",
		24,
		80,
		6
	)
end

-->8
--player

function init_player()
	player = {
		x = 60,
		y = 60,
		r = 4,
		tick = 0,
		rate = 0.25,
		sprite = 1,
		size = 1,
		flip = false
	}
end

function update_player()
	--movement
	if btn(⬅️) then
		player.x -= 1
		player.flip = false
		animate_sprite()
	end
	if btn(➡️) then
		player.x += 1
		player.flip = true
		animate_sprite()
	end
	if btn(⬆️) then
		player.y -= 1
		animate_sprite()
	end
	if btn(⬇️) then
		player.y += 1
		animate_sprite()
	end

	--check boundary
	if player.x < 0 then
		player.x = 0
	elseif player.x > 120 then
		player.x = 120
	elseif player.y < 0 then
		player.y = 0
	elseif player.y > 120 then
		player.y = 120
	end
end

function animate_sprite()
	player.tick += player.rate
	if player.tick >= 1 then
		player.tick = 0
		if player.sprite == 1 then
			player.sprite = 2
		else
			player.sprite = 1
		end
	end
end

function draw_player()
	spr(
		player.sprite,
		player.x,
		player.y,
		player.size,
		player.size,
		player.flip
	)
end

-->8
--lights

function init_lights()
	lights = {}
	max_lights = 10
	max_size = 8
	color = 10
	speed = 0.6
end

function create_light()
	local x, y, dx, dy = 0, 0, 0, 0
	local spawn = flr(rnd(4))

	if spawn < 2 then
		y = flr(rnd(128))
		dy = rnd(speed * 2) - speed

		if spawn == 0 then
			--left
			x, dx = -8, rnd(speed)
		else
			--right
			x, dx = 135, -rnd(speed)
		end
	else
		x = flr(rnd(128))
		dx = rnd(speed * 2) - speed

		if spawn == 2 then
			--top
			y, dy = -8, rnd(speed)
		else
			--bottom
			y, dy = 135, -rnd(speed)
		end
	end

	local light = {
		x = x,
		y = y,
		dx = dx,
		dy = dy,
		r = ceil(rnd(max_size))
	}

	add(lights, light)
end

function update_lights()
	if #lights < max_lights then
		create_light()
	end

	for light in all(lights) do
		--movement
		light.x += light.dx
		light.y += light.dy

		--outside screen
		if light.x < -8
				or light.x > 135
				or light.y < -8
				or light.y > 135 then
			del(lights, light)
		end

		check_collision(light)
	end
end

function draw_lights()
	for light in all(lights) do
		circfill(
			light.x,
			light.y,
			light.r,
			color
		)
	end
end

-->8
--collision

function check_collision(light)
	local x = player.x + player.r
	local y = player.y + player.r
	diff_x = (x - light.x) ^ 2
	diff_y = (y - light.y) ^ 2
	dist_sq = diff_x + diff_y

	if dist_sq < light.r ^ 2 then
		gameover = true
	end
end

-->8
--end

function init_end()
	gameover = false
	msg = {
		sprite = 136,
		x = 32,
		y = 32,
		w = 8,
		h = 4
	}
end

function update_end()
	if btnp(❎) then
		_init()
	end
end

function draw_end()
	spr(
		msg.sprite,
		msg.x,
		msg.y,
		msg.w,
		msg.h
	)
	print(
		"- press ❎ to restart -",
		20,
		80,
		6
	)
end

__gfx__
00000000007777000077770000aaaa0000aaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000007777770077777700aaaaaa00aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070007877870078778700a9aa9a00a9aa9a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700007777770077777700aaaaaa00aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700007777770077777700aaaaaa00aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070007777700077777000aaaaa000aaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007770000077770000aaa00000aaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000007770000007770000aaa000000aaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777700000000000000000000000000000000000000000000000000000000006777770000000000000000000000000000000000000000000000000
00000000077777770077000000000077770000000777770077777777770000000000000067777777067700000000067777000000677777067777777777000000
00000000777007770077000077000777777700007777770077777777770000000000000677700677067700067700677777770006777777067777777777000000
00000000777000000077000077000777777700007770000000007700000000000000000677700000067700067700677777770006777000000006770000000000
00000007770000000077000077007770007770007700000000007700000000000000006777000000067700067706777006777006770000000006770000000000
00000007770000000077000077007770007770007700000000007700000000000000006777000000067700067706777006777006770008008006770000000000
00000007700000000077777777007700000770007770000000007700000000000000006770000000067777777706770000677006777000000006770000000000
00000007700000000077777777007700000770007777000000007700000000000000006770000000067777777706770000677006777700000006770000000000
00000007700007700077700077007700000770000777700000007700000000000000006770006770067770067706770000677000677770000006770000000000
00000007700007700777000077007770000770000077700000007700000000000000006770006770677700067706777000677000067770000006770000000000
00000007700077700777000077007770007770000007770000007700000000000000006770067770677700067706777006777000006777000006770000000000
00000007770777700770000077000777077700077707770000007700000000000000006777677770677000067700677767770067706777000006770000000000
00000007777777700770000077000777777700077777770000007700000000000000006777777770677000067700677777770067777777000006770000000000
00000000777777700770000077000077777000007777770000007700000000000000000677777770677000067700067777700006777777000006770000000000
00000000000007700000000000000000000000000777000000007700000000000000000000006770000000000000000000000000677700000006770000000000
00000000000007700000000000000000000000000000000000007700000000000000000000006770000000000000000000000000000000000006770000000000
00000000000007700000000000000000000000000000000000007700000000000000000000006770000000000000000000000000000000000006770000000000
00000000000007700700700700700700707777707777007770007700000000000000000000006770070070070070070070777770777707770006770000000000
00000000000077700700700700700770700070007000007007007770000000000000000000067770070070070070077070007000700007007006777000000000
00000000000777700777700700700707700070007770007007007777000000000000000000677770077770070070070770007000777007007006777700000000
00000000000777000700700700700700700070007000007007000777000000000000000000677700070070070070070070007000700007007000677700000000
00000000000000000700700700700700700070007000007007000000000000000000000000000000070070070070070070007000700007007000000000000000
00000000000000000700700077070700700007007777007770000000000000000000000000000000070070007707070070000700777707770000000000000000
00000000000000000700000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000777770000000000000000000000000000000000000000000000000000000000677777000000000000000000000000000000000000000000000000
00000000007777777000007770000077000000000000007770000000000000000000000006777777700006777000067700000000000006777000006770000000
00000000077700777000007770000077700777007770007770077777700000000000000067770067700006777000067770677706777006777067777770000000
00000000077700000000077777000077707777077770000777777777700000000000000067770000000067777700067776777767777000677777777700000000
00000000777000000000077777000007777777777770000777777000000000000000000677700000000067777700006777777777777000677777700000000000
00000000777000000000777077700007777077770770000077000000000000000000000677700000000677767770006777767777677000067700000000000000
00000000770000000000777077700007770077700770000077000000000000000000000677000000000677706770006777067770677000067700000000000000
00000000770000000000770007700007700077000770000077000077000000000000000677000000000677006770006770067700677000067700067700000000
00000000770000770007770007700007700077000770000077777777000000000000000677000677006777006770006770067700677000067777777700000000
00000000770000770007777777700007700077000770000077777770000000000000000677000677006777777770006770067700677000067777777000000000
00000000770007770007777777700007700077000770000077000000000000000000000677006777006777777770006770067700677000067700000000000000
00000000777077770077700007700007700077000777000777000000000000000000000677767777067770006770006770067700677700677700000000000000
00000000777777770077700007770077700077700777000777000000000000000000000677777777067770006777067770067770677700677700000000000000
00000000077777770077000007770077700077700077000777777700000000000000000067777777067700006777067770067770067700677777770000000000
00000000000000770077000000770077000007700000007777777777700000000000000000000677067700000677067700006770000006777777777770000000
00000000000000770000000000000000000000000000007770007777700000000000000000000677000000000000000000000000000006777006777770000000
00000000000000770000000000000000000000000000000000000000000000000000000000000677000000000000000000000000000000000000000000000000
00000000000000770000000000000000000000000000000000000000000000000000000000000677000000000000000000000000000000000000000000000000
00000000000007770000077000700070077770077700000000000000000000000000000000006777000007700070007007777007770000000000000000000000
00000000000077770000700700700070070000070070000000000000000000000000000000067777000070070070007007000007007000000000000000000000
00000000000077700000700700700070077700070070000000000000000000000000000000067770000070070070007007770007007000000000000000000000
00000000000000000000700700070700070000077700000000000000000000000000000000000000000070070007070007000007770000000000000000000000
00000000000000000000700700070700070000070070000000000000000000000000000000000000000070070007070007000007007000000000000000000000
00000000000000000000077000007000077770070070000000000000000000000000000000000000000007700000700007777007007000000000000000000000
00000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000700000000000000000000
